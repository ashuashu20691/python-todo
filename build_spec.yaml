version: 0.1
component: build
timeoutInSeconds: 6000
runAs: root
shell: bash
env:
  variables:
      BUILDRUN_HASH: "0.0.1"

  vaultVariables:
    # Define any vault variables here if needed

  exportedVariables:
    - BUILDRUN_HASH

steps:
  - type: Command
    name: "Define unique image tag"
    timeoutInSeconds: 40
    command: |
      echo "first step running......."
      echo "BUILDRUN_HASH: " $BUILDRUN_HASH
      echo "OCI_PRIMARY_SOURCE_DIR: " $OCI_PRIMARY_SOURCE_DIR

  - type: Command
    timeoutInSeconds: 6000
    name: "Liquibase Migration"
    command: |
      - |
        echo "Checking Liquibase directory structure..."
        ls -l $OCI_PRIMARY_SOURCE_DIR/liquibase
        file $OCI_PRIMARY_SOURCE_DIR/liquibase/liquibase.properties     
        docker run --rm \
          -v $OCI_PRIMARY_SOURCE_DIR/liquibase/changelog:/liquibase/changelog:Z \
          -v $OCI_PRIMARY_SOURCE_DIR/liquibase/liquibase.properties:/liquibase/liquibase.properties:Z \
          -v $OCI_PRIMARY_SOURCE_DIR/liquibase/changelog/master-changelog.xml:/liquibase/changelog/master-changelog.xml:Z \
          -v $OCI_PRIMARY_SOURCE_DIR/Wallet_2:/app/Wallet_2:Z \
          -v $OCI_PRIMARY_SOURCE_DIR/jars/ojdbc8.jar:/liquibase/jars/ojdbc8.jar:Z \
          -e TNS_ADMIN=/app/Wallet_2 \
          liquibase/liquibase:4.27.0 \
          --defaultsFile=/liquibase/liquibase.properties \
          --search-path=/ \
          --changeLogFile=/liquibase/changelog/master-changelog.xml \
          update


  - type: Command
    timeoutInSeconds: 1200
    name: "Build container image"
    command: |
      cd ${OCI_PRIMARY_SOURCE_DIR}
      docker build --pull --rm -t todo-img .

outputArtifacts:
  - name: todo_image
    type: DOCKER_IMAGE
    location: todo-img:latest

  - name: oke_deploy_manifest
    type: BINARY
    location: ${OCI_PRIMARY_SOURCE_DIR}/kubernate.yaml